<HTML>
    <HEAD>
        <SCRIPT LANGUAGE="JavaScript">

// HTML element of the body of the table that holds the ranked list of all combinations
// of class combinations
var theTableBody

// Load the classes array the details of each class
var classes = [
        [
            new ClassTime( "SCMA", "2000", "01", "R", "13:35", "16:15" ),
            new ClassTime( "SCMA", "2000", "02", "F", "9:00", "11:40" ),
            new ClassTime( "SCMA", "2000", "03", "F", "9:00", "11:40" ),
            new ClassTime( "SCMA", "2000", "04", "F", "12:40", "15:20" ),
            new ClassTime( "SCMA", "2000", "05", "F", "12:40", "15:20" ),
        ], [
            new ClassTime( "BADM", "2010", "01", "M", "8:05", "10:45" ),
            new ClassTime( "BADM", "2010", "02", "M", "14:30", "17:10" ),
            new ClassTime( "BADM", "2010", "03", "W", "9:00", "11:40" ),
            new ClassTime( "BADM", "2010", "04", "W", "12:40", "15:20" ),
        ], [
            new ClassTime( "BADM", "2020", "01", "M", "8:05", "10:45" ),
            new ClassTime( "BADM", "2020", "02", "M", "11:45", "14:25" ),
            new ClassTime( "BADM", "2020", "03", "T", "10:50", "13:30" ),
            new ClassTime( "BADM", "2020", "04", "T", "17:15",  "19:55" ),
            new ClassTime( "BADM", "2020", "05", "W", "17:15", "19:55" ),
        ], [
            new ClassTime( "BADM", "2000", "01", "T", "8:05", "10:45" ),
            new ClassTime( "BADM", "2000", "02", "T", "17:15", "19:55" ),
            new ClassTime( "BADM", "2000", "03", "W", "13:35", "16:15" ),
            new ClassTime( "BADM", "2000", "04", "R", "9:00", "11:40" ),
            new ClassTime( "BADM", "2000", "05", "R", "14:40", "15:20" ),
        ], [
            new ClassTime( "BADM", "1030", "01", "T", "9:00", "11:40" ),
            new ClassTime( "BADM", "1030", "02", "T", "11:45", "14:25" ),
            new ClassTime( "BADM", "1030", "03", "W", "8:05", "10:45" ),
            new ClassTime( "BADM", "1030", "04", "W", "14:40", "15:20" ),
            new ClassTime( "BADM", "1030", "05", "W", "16:20", "19:00" ),
        ]
];



function init() {
    // theTable = (document.all) ? document.all.myTABLE : document.getElementById("schedule")
    theTable = document.getElementById("schedule");
    theTableBody = theTable.tBodies[0];

    // Reconstruct the classes table from the "classes" data itself
    var classesTable = document.getElementsByName("classesTable")[0];
    var classesTableBody = classesTable.tBodies[0];
    while( classesTableBody.hasChildNodes() ) {
        classesTableBody.removeChild( classesTableBody.firstChild );
    }
    for ( var i = 0; i < classes.length; i++ ) {
        var thisClass = classes[i]
        for ( var sectionNum = 0; sectionNum < thisClass.length; sectionNum++ ) {

            var section = thisClass[sectionNum]
            var newRow = classesTableBody.insertRow(classesTableBody.rows.length);
            if ( (i % 2) == 0 ) {
                newRow.bgColor = "#ededed";
            }

            var cellNum = 0;
            var newCell;

            newCell = newRow.insertCell(cellNum++);
            newCell.align="center";
            newCell.innerHTML = section.program;

            newCell = newRow.insertCell(cellNum++);
            newCell.align="center";
            newCell.innerHTML = section.course;

            newCell = newRow.insertCell(cellNum++);
            newCell.align="right";
            newCell.innerHTML = section.section;

            newCell = newRow.insertCell(cellNum++);
            newCell.align="center";
            newCell.innerHTML = section.day;

            newCell = newRow.insertCell(cellNum++);
            newCell.align="right";
            newCell.innerHTML = section.startTime;

            newCell = newRow.insertCell(cellNum++);
            newCell.align="right";
            newCell.innerHTML = section.endTime;

            newCell = newRow.insertCell(cellNum++);
            newCell.align="center";
            newCell.innerHTML = "<input name=\"c" + i + "s" + sectionNum + "\" onchange=\"genSchedule()\" type=checkbox checked>"
        }
    }
}


function genSchedule()
{
    var result = [];
    var schedule = [];

    genCourses( 0, schedule, result );

    // Sort the result by badness
    result.sort( scheduleComparator );

    while( theTableBody.hasChildNodes() ) {
        theTableBody.removeChild( theTableBody.firstChild );
    }
    
    // theTableBody.innerHTML = "";
    var newLength = theTableBody.rows.length;

    for ( var i = 0; i < result.length; i++ ) {
       appendTableRow( result[i] );
    }
}


function appendTableRow(data) {
    var newRow = theTableBody.insertRow(theTableBody.rows.length);

    var i = 0;
    for ( i = 0; i < data.length; i++ ) {
        var newCell = newRow.insertCell(i);
        newCell.innerHTML = data[i];
    }
}


function scheduleComparator( a, b )
{
    return ( b[b.length-1] - a[a.length-1] );
}


// Define the ClassTime object
function ClassTime( program, course, section, day, startTime, endTime )
{
    // ParseTime(): Returns the interval number (in the range 0..143) corresponding to this start time
    // 0 == 8:00am
    // 143 == 7:55pm
    this.parseTime = function( time ) {
        // Find the ':' and split it into two components
        var colonIndex = time.indexOf( ":" );
        var hours = time.substring( 0, colonIndex );
        var mins = time.substring( colonIndex + 1 );
        return ( hours - 8 ) * 12 + mins / 5;
    };

    var dayValues = [];
    dayValues['M'] = 0 * 144;
    dayValues['T'] = 1 * 144;
    dayValues['W'] = 2 * 144;
    dayValues['R'] = 3 * 144;
    dayValues['F'] = 4 * 144;

    this.program = program;
    this.course = course;
    this.section = section;
    this.day = day;
    this.startTime = startTime;
    this.endTime = endTime;

    var dayValue = dayValues[ day ];
    this.start = this.parseTime( startTime ) + dayValue;
    this.end = this.parseTime( endTime ) + dayValue;

    this.toString = function() {
        return this.day + ":" + this.startTime + "-" + this.endTime + " (" + this.program + "/" + this.course + "/" + this.section + ")";
    };
}


function ClassTimeComparator( a, b )
{
    return ( a.start - b.start );
}


// Recursive function 
var MIN_CLASS_TIME = 5 * 30 / 5; // (5 half-hour periods after 8:00am = 10:30am, broken down into 5-minute chunks)
var MAX_CLASS_TIME = 9 * 60 / 5; // (9 hour-long periods after 8:00am = 5:00pm, broken down into 5-minute chunks)
function genCourses( depth, schedule, result )
{
    if ( depth == classes.length ) {

        // Sort the classes in the schedule 
        var tmpSchedule = [];
        for ( var i = 0; i < schedule.length; i++ ) {
            tmpSchedule[i] = schedule[i];
        }
        tmpSchedule.sort( ClassTimeComparator );

        // Evaluate
        var days = [];
        var score = 0;
        for ( var i = 0; i < tmpSchedule.length; i++ ) {
            var ct = tmpSchedule[i];
            var start = ct.start;
            var end = ct.end;

            // Scoring:
            // - Penalty for classes starting before 10:30am
            var dayStart = start % 144;
            if ( dayStart < MIN_CLASS_TIME ) {
                score += parseInt( document.penalties.earlyMorningPenalty.value );
            }

            // - Penalty for classes starting after 5:00pm
            var dayStart = start % 144;
            if ( dayStart >= MAX_CLASS_TIME ) {
                score += parseInt( document.penalties.eveningPenalty.value );
            }

            // - Penalty for each class on a Monday or Friday
            if ( start < 144 ) {
                score += parseInt( document.penalties.mondaysPenalty.value );
            } else if ( start >= ( 144 * 3 ) && start < ( 144 * 4 ) ) {
                score += parseInt( document.penalties.thursdaysPenalty.value );
            } else if ( start >= ( 144 * 4 ) ) {
                score += parseInt( document.penalties.fridaysPenalty.value );
            }

            // - Penalty for every inter-class gap that is less than 1 hour
            if ( i > 0 ) {
                if ( ( start - tmpSchedule[i-1].end ) < 12 ) {
                    score += parseInt( document.penalties.interClassPenalty.value );
                }
            }

            // Record which day this one starts on, for the days-with-more-than-2-classes penalty
            var dayIndex = Math.floor( start / 144 );
            if ( typeof days[dayIndex] == "undefined" ) {
                days[dayIndex] = 0;
            }
            days[dayIndex]++;
        }

        // **** NOT USING THIS FOR NOW ****
        // - Penalty for every day with more than 2 classes
        // for ( var i = 0 ; i < 5; i++ ) {
        //     if ( days[i] > 2 ) {
        //         score += parseInt( document.penalties.tooManyClassesPerDayPenalty.value );
        //     }
        // }

        tmpSchedule.push( score )

        // Record this schedule in the result
        result.push( tmpSchedule );

    } else {
        // Iterate over the classes of the course
        for ( var i = 0; i < classes[depth].length; i++ ) {

            // First make sure that this class is actually available
            var id = "c" + depth + "s" + i;
            if ( !document.getElementsByName( id )[0].checked ) {
                continue;
            }

            // Make sure no other classes overlap with this one
            var ct = classes[depth][i];

            var bad = false;
            var j;
            for ( j = 0; j < depth; j++ ) {
                if ( !( ct.end < schedule[j].start ||
                        ct.start > schedule[j].end ) ) {
                            bad = true;
                            break;
                        }
            }

            if ( !bad ) {
                // All is ok from an overlap perspective, so proceed to the next level
                schedule[depth] = ct;
                genCourses( depth + 1, schedule, result );
            }
        }
    }
}
        </SCRIPT>
    </HEAD>
    <BODY onload="init(); genSchedule()">
        <table>
            <tr><td>
                <form name="classesForm">
                <table border=1 name="classesTable" rules=all>
                    <thead>
                    <tr>
                        <th>Program</th>
                        <th>Course</th>
                        <th>Section</th>
                        <th>Day</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Still<br>Available</th>
                    </tr>
                    <tbody>
                    </tbody>
                </table>
            </form>
            </td><td>
            <DIV STYLE="overflow: auto; width: 1400; height: 600; 
                        border-left: 1px gray solid; border-bottom: 1px gray solid; 
                        padding:0px; margin: 0px">
                        <table rules=all cellpadding=3 id="schedule"><tbody></tbody></table>
            </DIV>
            </td></tr>
        </table>
        <br>
        <form name="penalties">
        <table rules=all>
            <tr><th>Penalty Type</th><th>Penalty Amount</th></tr>
            <tr><td>Start time before 10:30am</td><td><input name="earlyMorningPenalty" value="-200" onchange="genSchedule()"></td></tr>
            <tr><td>Start time after 5:00pm</td><td><input name="eveningPenalty" value="-200" onchange="genSchedule()"></td></tr>
            <tr><td>Mondays</td><td><input name="mondaysPenalty" value="0" onchange="genSchedule()"></td></tr>
            <tr><td>Thursdays</td><td><input name="thursdaysPenalty" value="-300" onchange="genSchedule()"></td></tr>
            <tr><td>Fridays</td><td><input name="fridaysPenalty" value="-500" onchange="genSchedule()"></td></tr>
            <tr><td>Time between classes &lt; 1 hour</td><td><input name="interClassPenalty" value="-100" onchange="genSchedule()"></td></tr>
            <!-- <tr><td>Penalty for every day with more than 2 classes&nbsp;&nbsp;</td><td><input name="tooManyClassesPerDayPenalty" value="-500" onchange="genSchedule()"></td></tr> -->
        </table>
    </form>
    </BODY>
</HTML>
